<!DOCTYPE html>
<html>
<head>
    <title>VR Whack-a-Mole Game</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
</head>
<body>
    <a-scene background="color: #87CEEB" vr-mode-ui="enabled: true">
        <!-- Assets -->
        <a-assets>
            <a-mixin id="mole-animation" 
                     animation__up="property: position; dur: 500; easing: easeOutQuad"
                     animation__down="property: position; dur: 300; easing: easeInQuad; startEvents: hide">
            </a-mixin>
        </a-assets>

        <!-- Lighting -->
        <a-light type="ambient" color="#404040"></a-light>
        <a-light type="directional" position="2 4 2" color="#ffffff"></a-light>

        <!-- Ground -->
        <a-plane position="0 0 0" rotation="-90 0 0" width="10" height="10" color="#228B22"></a-plane>

        <!-- Game Board - 9 holes in 3x3 grid (made deeper) -->
        <!-- Row 1 -->
        <a-cylinder id="hole1" position="-2 -0.3 -2" radius="0.6" height="0.6" color="#654321"></a-cylinder>
        <a-cylinder id="hole2" position="0 -0.3 -2" radius="0.6" height="0.6" color="#654321"></a-cylinder>
        <a-cylinder id="hole3" position="2 -0.3 -2" radius="0.6" height="0.6" color="#654321"></a-cylinder>

        <!-- Row 2 -->
        <a-cylinder id="hole4" position="-2 -0.3 0" radius="0.6" height="0.6" color="#654321"></a-cylinder>
        <a-cylinder id="hole5" position="0 -0.3 0" radius="0.6" height="0.6" color="#654321"></a-cylinder>
        <a-cylinder id="hole6" position="2 -0.3 0" radius="0.6" height="0.6" color="#654321"></a-cylinder>

        <!-- Row 3 -->
        <a-cylinder id="hole7" position="-2 -0.3 2" radius="0.6" height="0.6" color="#654321"></a-cylinder>
        <a-cylinder id="hole8" position="0 -0.3 2" radius="0.6" height="0.6" color="#654321"></a-cylinder>
        <a-cylinder id="hole9" position="2 -0.3 2" radius="0.6" height="0.6" color="#654321"></a-cylinder>

        <!-- Moles (start hidden below ground) -->
        <!-- Box Moles -->
        <a-box id="mole1" mixin="mole-animation" position="-2 -0.8 -2" width="0.8" height="0.8" depth="0.8" 
               color="#8B4513" class="mole" visible="true">
        </a-box>

        <a-sphere id="mole2" mixin="mole-animation" position="0 -0.8 -2" radius="0.4" 
                  color="#D2691E" class="mole" visible="true">
        </a-sphere>

        <a-box id="mole3" mixin="mole-animation" position="2 -0.8 -2" width="0.8" height="0.8" depth="0.8" 
               color="#8B4513" class="mole" visible="true">
        </a-box>

        <a-sphere id="mole4" mixin="mole-animation" position="-2 -0.8 0" radius="0.4" 
                  color="#D2691E" class="mole" visible="true">
        </a-sphere>

        <a-box id="mole5" mixin="mole-animation" position="0 -0.8 0" width="0.8" height="0.8" depth="0.8" 
               color="#8B4513" class="mole" visible="true">
        </a-box>

        <a-sphere id="mole6" mixin="mole-animation" position="2 -0.8 0" radius="0.4" 
                  color="#D2691E" class="mole" visible="true">
        </a-sphere>

        <a-box id="mole7" mixin="mole-animation" position="-2 -0.8 2" width="0.8" height="0.8" depth="0.8" 
               color="#8B4513" class="mole" visible="true">
        </a-box>

        <a-sphere id="mole8" mixin="mole-animation" position="0 -0.8 2" radius="0.4" 
                  color="#D2691E" class="mole" visible="true">
        </a-sphere>

        <a-box id="mole9" mixin="mole-animation" position="2 -0.8 2" width="0.8" height="0.8" depth="0.8" 
               color="#8B4513" class="mole" visible="true">
        </a-box>

        <!-- Score Display -->
        <a-text id="score" position="-1 3 -3" value="Score: 0" color="white" align="center" 
                width="8" font="dejavu"></a-text>

        <!-- Timer Display -->
        <a-text id="timer" position="1 3 -3" value="Time: 60" color="white" align="center" 
                width="8" font="dejavu"></a-text>

        <!-- Camera with cursor for VR -->
        <a-camera position="0 1.6 4" look-controls wasd-controls>
            <a-cursor position="0 0 -1" geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                      material="color: white; shader: flat" 
                      animation__click="property: scale; startEvents: click; from: 0.1 0.1 0.1; to: 1 1 1; dur: 150"
                      animation__fuse="property: scale; startEvents: fuse; from: 1 1 1; to: 1.2 1.2 1.2; dur: 150"
                      raycaster="objects: .mole">
            </a-cursor>
        </a-camera>
    </a-scene>

    <script>
        // Game variables
        let score = 0;
        let timeLeft = 60;
        let gameActive = true;
        let activeMoles = [];

        // Mole positions - start hidden below, pop up above ground
        const molePositions = [
            { down: "-2 -0.8 -2", up: "-2 0.8 -2" },   // mole1 (box)
            { down: "0 -0.8 -2", up: "0 0.6 -2" },     // mole2 (sphere)
            { down: "2 -0.8 -2", up: "2 0.8 -2" },     // mole3 (box)
            { down: "-2 -0.8 0", up: "-2 0.6 0" },     // mole4 (sphere)
            { down: "0 -0.8 0", up: "0 0.8 0" },       // mole5 (box)
            { down: "2 -0.8 0", up: "2 0.6 0" },       // mole6 (sphere)
            { down: "-2 -0.8 2", up: "-2 0.8 2" },     // mole7 (box)
            { down: "0 -0.8 2", up: "0 0.6 2" },       // mole8 (sphere)
            { down: "2 -0.8 2", up: "2 0.8 2" }        // mole9 (box)
        ];

        // Get DOM elements
        const scoreDisplay = document.querySelector('#score');
        const timerDisplay = document.querySelector('#timer');
        const moles = document.querySelectorAll('.mole');

        // Track which moles are currently active (popped up)
        let moleStates = new Array(9).fill(false); // false = hidden, true = visible

        // Add click listeners to all moles
        moles.forEach((mole, index) => {
            mole.addEventListener('click', () => hitMole(index));
            mole.addEventListener('fuse', () => hitMole(index)); // For gaze interaction
        });

        // Hit mole function
        function hitMole(moleIndex) {
            if (!gameActive || !moleStates[moleIndex]) return;
            
            const mole = moles[moleIndex];
            
            // Hide the mole
            hideMole(moleIndex);
            
            // Update score
            score += 10;
            scoreDisplay.setAttribute('value', `Score: ${score}`);
            
            // Visual feedback - flash red
            const originalColor = mole.getAttribute('color');
            mole.setAttribute('color', '#FF0000');
            setTimeout(() => {
                mole.setAttribute('color', originalColor);
            }, 200);
        }

        // Show mole function
        function showMole(moleIndex) {
            const mole = moles[moleIndex];
            const upPosition = molePositions[moleIndex].up;
            
            // Set animation target and trigger
            mole.setAttribute('animation__up', `to: ${upPosition}; startEvents: popup`);
            mole.emit('popup');
            
            moleStates[moleIndex] = true;
            activeMoles.push(moleIndex);
        }

        // Hide mole function
        function hideMole(moleIndex) {
            const mole = moles[moleIndex];
            const downPosition = molePositions[moleIndex].down;
            
            // Set animation target and trigger
            mole.setAttribute('animation__down', `to: ${downPosition}; startEvents: hide`);
            mole.emit('hide');
            
            moleStates[moleIndex] = false;
            
            // Remove from active moles
            const index = activeMoles.indexOf(moleIndex);
            if (index > -1) {
                activeMoles.splice(index, 1);
            }
        }

        // Show random mole
        function showRandomMole() {
            if (!gameActive) return;
            
            // Don't show too many moles at once
            if (activeMoles.length >= 3) return;
            
            // Get available moles (not currently visible)
            const availableMoles = [];
            for (let i = 0; i < 9; i++) {
                if (!moleStates[i]) {
                    availableMoles.push(i);
                }
            }
            
            if (availableMoles.length === 0) return;
            
            // Pick random mole
            const randomIndex = Math.floor(Math.random() * availableMoles.length);
            const selectedMoleIndex = availableMoles[randomIndex];
            
            // Show the mole
            showMole(selectedMoleIndex);
            
            // Hide mole after random time (1.5-3 seconds)
            const hideTime = Math.random() * 1500 + 1500;
            setTimeout(() => {
                if (moleStates[selectedMoleIndex] && gameActive) {
                    hideMole(selectedMoleIndex);
                }
            }, hideTime);
        }

        // Game timer
        function updateTimer() {
            if (!gameActive) return;
            
            timeLeft--;
            timerDisplay.setAttribute('value', `Time: ${timeLeft}`);
            
            if (timeLeft <= 0) {
                endGame();
            }
        }

        // End game
        function endGame() {
            gameActive = false;
            
            // Hide all active moles
            for (let i = 0; i < 9; i++) {
                if (moleStates[i]) {
                    hideMole(i);
                }
            }
            
            // Show final score
            setTimeout(() => {
                timerDisplay.setAttribute('value', `Game Over!`);
                scoreDisplay.setAttribute('value', `Final Score: ${score}`);
            }, 500);
        }

        // Start game
        function startGame() {
            console.log("Game starting...");
            
            // Show moles every 1-2 seconds
            const moleInterval = setInterval(() => {
                if (gameActive) {
                    showRandomMole();
                } else {
                    clearInterval(moleInterval);
                }
            }, Math.random() * 1000 + 1000);
            
            // Update timer every second
            const timerInterval = setInterval(() => {
                if (gameActive) {
                    updateTimer();
                } else {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }

        // Start the game after scene loads
        document.querySelector('a-scene').addEventListener('loaded', () => {
            console.log("Scene loaded, starting game in 2 seconds...");
            setTimeout(startGame, 2000);
        });
    </script>
</body>
</html>
